<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="stylesheet" href="style.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</title>
<script type="module" src="firebase.js"></script>
<style>
body { font-family: Arial; padding: 20px; background:#f0f4f8; }
input, select, textarea, button { width:100%; padding:12px; margin:8px 0; border-radius:8px; }
button { background:#007bff; color:white; border:none; cursor:pointer; }
button:hover { background:#0056b3; }
.card { background:white; padding:20px; margin:15px 0; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
img.ad-img { max-width:100%; border-radius:8px; margin-top:10px; }
</style>
</head>
<body>

<h2>Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© OBS</h2>

<div class="card">
  <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
  <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
  <select id="type">
    <option>Ù…Ø­ØªØ§Ø¬ Ø®Ø¯Ù…Ø©</option>
    <option>Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©</option>
  </select>
  <textarea id="desc" placeholder="ÙˆØµÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"></textarea>
  <input type="file" id="imageFile">
  <select id="position">
    <option value="top">Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©</option>
    <option value="bottom">Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©</option>
  </select>
  <button id="send">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
</div>

<div class="card">
  <h3>ğŸ“„ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ</h3>
  <div id="myAds"></div>
</div>

<script type="module">
import { db, storage, auth } from './firebase.js';
import { collection, addDoc, getDocs, doc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
import { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

let currentUserId = null;

// Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
onAuthStateChanged(auth, user => {
  if(user) currentUserId = user.uid;
  else {
    let email = prompt("Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
    let pass = prompt("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    createUserWithEmailAndPassword(auth,email,pass).catch(err=>{
      signInWithEmailAndPassword(auth,email,pass).catch(err2=>alert(err2.message));
    });
  }
});

// Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
document.getElementById("send").onclick = async () => {
  const name = document.getElementById("name").value;
  const type = document.getElementById("type").value;
  const desc = document.getElementById("desc").value;
  const position = document.getElementById("position").value;
  const file = document.getElementById("imageFile").files[0];
  if(!name || !desc) return alert("Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  let imageUrl = "";
  if(file){
    const imageRef = ref(storage, `ads_images/${Date.now()}_${file.name}`);
    await uploadBytes(imageRef,file);
    imageUrl = await getDownloadURL(imageRef);
  }

  await addDoc(collection(db,"ads"),{
    userId: currentUserId,
    name, type, desc, position, imageUrl, featured:false,
    date:new Date().toLocaleString()
  });

  alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  loadAds();
};

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function loadAds(){
  const myAdsDiv = document.getElementById("myAds");
  myAdsDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  const q = query(collection(db,"ads"), where("userId","==",currentUserId));
  const snapshot = await getDocs(q);
  myAdsDiv.innerHTML = "";
  snapshot.forEach(ad=>{
    const data = ad.data();
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<b>${data.type}</b><br>ğŸ“„ ${data.desc}<br>
      ${data.imageUrl?`<img src="${data.imageUrl}" class="ad-img">`:''}
      <br><small>${data.date}</small>`;
    myAdsDiv.appendChild(div);
  });
}
</script>

</body>
</html>
